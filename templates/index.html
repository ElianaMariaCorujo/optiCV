<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opti-CV | Cliente de API</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>Opti-CV (Versión API)</h1>
        <p>Rellena los campos para guardar tu CV en la base de datos.</p>

        <form id="cv-form">
            
            <fieldset>
                <legend>Información de Contacto</legend>
                <label for="nombre_completo">Nombre Completo:</label>
                <input type="text" id="nombre_completo" name="nombre_completo" required>

                <label for="email">Email:</label>
                <input type="email" id="email" name="email" required>
                
                <label for="telefono">Teléfono:</label>
                <input type="tel" id="telefono" name="telefono">
                
                <label for="ubicacion">Ubicación:</label>
                <input type="text" id="ubicacion" name="ubicacion">
            </fieldset>

            <fieldset>
                <legend>Enlaces</legend>
                <label for="linkedin">LinkedIn:</label>
                <input type="url" id="linkedin" name="linkedin">
                
                <label for="github">GitHub:</label>
                <input type="url" id="github" name="github">
            </fieldset>
            
            <fieldset>
                <legend>Perfil</legend>
                <label for="resumen">Resumen Profesional:</label>
                <textarea id="resumen" name="resumen" rows="5"></textarea>
                
                <label for="habilidades">Habilidades (separadas por coma):</label>
                <textarea id="habilidades" name="habilidades" rows="3"></textarea>
                
                <label for="idiomas_certs">Idiomas y Certs:</label>
                <textarea id="idiomas_certs" name="idiomas_certs" rows="3"></textarea>
            </fieldset>
            
            <button type="submit">Guardar CV en la Base de Datos</button>
        </form>

        <div id="respuesta-api" style="display:none; margin-top: 20px;">
            <h3>Respuesta del Servidor:</h3>
            <pre id="respuesta-json"></pre>
            <a href="#" id="link-pdf" target="_blank" style="display:none;">Descargar PDF</a>
        </div>
    </div>

    <script>
        // --- Nuevo JavaScript para hablar con la API ---
        document.getElementById('cv-form').addEventListener('submit', function(evento) {
            evento.preventDefault(); // Evita que el formulario se envíe de la forma tradicional

            // 1. Recolecta los datos del formulario
            const formData = new FormData(evento.target);
            const datos = Object.fromEntries(formData.entries());

            // (Aquí añadiremos la lógica para recolectar experiencia y formación luego)

            console.log("Enviando datos a la API:", datos);

            // 2. Envía los datos como JSON a la API
            fetch('/api/v1/cv', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datos)
            })
            .then(response => response.json())
            .then(data => {
                // 3. Muestra la respuesta del servidor
                console.log("Respuesta de la API:", data);
                const respuestaDiv = document.getElementById('respuesta-api');
                const respuestaJSON = document.getElementById('respuesta-json');
                const linkPDF = document.getElementById('link-pdf');

                respuestaJSON.textContent = JSON.stringify(data, null, 2);
                respuestaDiv.style.display = 'block';

                if (data.id) {
                    // Si la creación fue exitosa, muestra el link de descarga
                    linkPDF.href = `/api/v1/cv/${data.id}/pdf`;
                    linkPDF.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                const respuestaDiv = document.getElementById('respuesta-api');
                const respuestaJSON = document.getElementById('respuesta-json');
                respuestaJSON.textContent = `Error al conectar con la API: ${error}`;
                respuestaDiv.style.display = 'block';
            });
        });
    </script>
</body>
</html>